\documentclass[OPS,lsstdraft,authoryear,toc]{lsstdoc}
\input{meta}

% Package imports go here.

% Local commands go here.

%If you want glossaries
%\input{aglossary.tex}
%\makeglossaries

\title{Rubin Observatory Raw Data File Format}

% This can write metadata into the PDF.
% Update keywords and author information as necessary.
\hypersetup{
    pdftitle={Rubin Observatory Raw Data File Format},
    pdfauthor={TimJenness},
    pdfkeywords={}
}

% Optional subtitle
% \setDocSubtitle{A subtitle}

\input{authors}

\setDocRef{CTN-004}
\setDocUpstreamLocation{\url{https://github.com/lsst/ctn-004}}

\date{\vcsDate}

% Optional: name of the document's curator
% \setDocCurator{The Curator of this Document}

\setDocAbstract{%
At the NSF-DOE Vera C. Rubin Observatory we write data from the LSSTCam and LATISS instruments using FITS format with one file written per detector. Here we discuss the layout of those FITS files and describe the FITS headers.
}

% Change history defined here.
% Order: oldest first.
% Fields: VERSION, DATE, DESCRIPTION, OWNER NAME.
% See LPM-51 for version number policy.
\setDocChangeRecord{%
  \addtohist{1}{YYYY-MM-DD}{Unreleased.}{Jenness}
}


\begin{document}

% Create the title page.
\maketitle
% Frequently for a technote we do not want a title page  uncomment this to remove the title page and changelog.
% use \mkshorttitle to remove the extra pages

% ADD CONTENT HERE
% You can also use the \input command to include several content files.

\section{Introduction}

All three cameras at the NSF-DOE Vera C.\ Rubin Observatory, (LSSTCam \citep{10.71929/rubin/2571927}, LATISS \citep{10.71929/rubin/2571930}, and LSSTComCam \citep{10.71929/rubin/2561361}) write FITS output files in the same structure with some minor variations in the FITS headers indicating different software versions and capabilities.

\citeds{LCA-10140} and \citeds{LCA-13501} define the file format used for the test stand at SLAC and \citeds{LSE-400} describes an example header that was used early in the construction project.
This document describes the delivered system and any evolution of the format that happens during the observatory lifetime.

\section{Structure}

The basic layout of a Rubin camera FITS file is shown in Fig.~\ref{fig:layout}.
There is a primary header, with no data, containing the FITS headers for this observation.
Then there are 16 HDUs, named \texttt{SegmentNN}, with the data from each amplifier along with headers specific to that amplifier.
The data values are 32-bit integers compressed using the Rice compression algorithm \citep{2012arXiv1201.1336W}.
Finally there are two extensions describing the condition of the readout electronics board (\texttt{REB\_COND}) and checksums calculated from the camera configuration (\texttt{CONFIG\_COND}).

\begin{figure}
  \begin{center}
\begin{verbatim}
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU     134   ()
  1  Segment10     1 CompImageHDU    115   (576, 2048)   int32
  2  Segment11     1 CompImageHDU    115   (576, 2048)   int32
  3  Segment12     1 CompImageHDU    115   (576, 2048)   int32
  4  Segment13     1 CompImageHDU    115   (576, 2048)   int32
  5  Segment14     1 CompImageHDU    115   (576, 2048)   int32
  6  Segment15     1 CompImageHDU    115   (576, 2048)   int32
  7  Segment16     1 CompImageHDU    115   (576, 2048)   int32
  8  Segment17     1 CompImageHDU    115   (576, 2048)   int32
  9  Segment07     1 CompImageHDU    115   (576, 2048)   int32
 10  Segment06     1 CompImageHDU    115   (576, 2048)   int32
 11  Segment05     1 CompImageHDU    115   (576, 2048)   int32
 12  Segment04     1 CompImageHDU    115   (576, 2048)   int32
 13  Segment03     1 CompImageHDU    115   (576, 2048)   int32
 14  Segment02     1 CompImageHDU    115   (576, 2048)   int32
 15  Segment01     1 CompImageHDU    115   (576, 2048)   int32
 16  Segment00     1 CompImageHDU    115   (576, 2048)   int32
 17  REB_COND      1 BinTableHDU    107   0R x 0C   []
 18  CONFIG_COND    1 BinTableHDU     26   0R x 0C   []
\end{verbatim}
\end{center}
\caption{Layout of a LSSTCam raw file.}
\label{fig:layout}
\end{figure}

\section{FITS Headers}

\subsection{LSSTCam Header}

The definitions of how specific timing FITS headers relate to events inside the camera are described in \citeds{CTN-005}.

\input{lsstcam-primary}

\subsection{LATISS Header}

\input{auxtel-primary}

\subsection{Amplifier Header}

\input{amplifier}

\subsection{REB Condition Header}

\input{reb_cond}

\subsection{Configuration Condition Header}

\input{config_cond}

\appendix

\section{Version Changes}

When the FITS header schema is changed in any way there is a corresponding increment to the value stored in the \texttt{HEADVER} FITS card.
This document describes the file format starting with version 2, which is the version that was used from the beginning of commissioning.

Errors in the contents of specific FITS headers are not documented here but are instead handled by the \texttt{astro\_metadata\_translator} package \footnote{\url{https://astro-metadata-translator.lsst.io/}} in conjunction with the \texttt{obs\_lsst} package that are both part of the LSST Science Pipelines \citedsp{PSTN-019}.
In particular, if you are not using the LSST Science Pipelines to read the raw data via the Data Butler \citep{2022SPIE12189E..11J}, some headers are likely to be incorrect or missing if you do not manually run the \texttt{astro\_metadata\_translator.fix\_header()} function on the primary header.

\subsection{Version 3}

\begin{itemize}
\item The \texttt{DATE} header is now correctly being reported in UTC timescale, conforming with the FITS standard \citep{2010A&A...524A..42P}.
\item Removed the \texttt{MJD} header card as it was confusing to users since whilst \texttt{DATE} is part of the standard, the MJD equivalent is not, and it would not be clear whether it was UTC or matched \texttt{TIMESYS}.
\end{itemize}

\section{Acknowledgements}

This material is based upon work supported in part by the National Science Foundation through Cooperative Agreements AST-1258333 and AST-2241526 and Cooperative Support Agreements AST-1202910 and AST-2211468 managed by the Association of Universities for Research in Astronomy (AURA), and the Department of Energy under Contract No.\ DE-AC02-76SF00515 with the SLAC National Accelerator Laboratory managed by Stanford University.
Additional Rubin Observatory funding comes from private donations, grants to universities, and in-kind support from LSST-DA Institutional Members.

% Include all the relevant bib files.
% https://lsst-texmf.lsst.io/lsstdoc.html#bibliographies
\section{References} \label{sec:bib}
\renewcommand{\refname}{} % Suppress default Bibliography section
\bibliography{local,lsst,lsst-dm,refs_ads,refs,books}

% Make sure lsst-texmf/bin/generateAcronyms.py is in your path
\section{Acronyms} \label{sec:acronyms}
\input{acronyms.tex}
% If you want glossary uncomment below -- comment out the two lines above
%\printglossaries





\end{document}
